# eto_weather

This is a how-to implement the ETo processing scripts.
(And is a work in progress)

The project "poli" and the "minisom" code must be working before using this code. 

A pristine directory listing will look like this:

apply_class.py   cramer.py  graphics  paper_output  run_cramer.py
collect_data.py  dates      luts      README.md     train_msom.py

- Collecting the data:- 

To start the processing, use "collect_data.py" to assemble and normalize the input training data for SOM. As with most of these prototype scripts, parameters are adjusted (edited) inside the scripts.

For "collect_data.py" the relevant parameters to change are:

datapath = '/home/agrineer/eto_weather/dates/full2017.txt' 

outpath = 'full2017.npy'

The above files are the input/output filenames to use.

The "datapath" variable points to a list of dates to use. The "outpath" variable names the produced "numpy" file that is used for training. Execute with:

\> ./collect_data.py

where '\>' indicates the command prompt.

NOTE: for security and robustness the current directory, ".", is excluded from the shell variable "PATH". To run a program from the current directory use the './" prefix.

NOTE: "POLI" (Python On Line Imaging) must be installed and pointed to in PYTHONPATH shell variable.

The Python script "collect_data.py" reads 10 variable values from a WRF output file and then uses these variables to create the 8 variables (with proper units) used in the ETo equation (Penman-Montieth per FAO) on an hourly basis for a day.

Pointing to the file "full2017.txt" means we are using 365 days of WRF data for 2017 as our training set.

The 8 variable are interlaced as attributes on an hourly basis, so normalization for each variable also nedds to be interlaced. 

For example:

rad(1st hour ) temp(1st hour) wind(1st hour) ... rad(2nd) temp(2nd) wind(

So, to normalize the radiation attribute we have to skip the other variable values.

"collect_data.py" takes a while, and typically depends if the input data has already been accessed.

- Cluster the data

The next processing step is to derive cluster classes for ETo "weather". Use "train_msom.py". This implements the modified MiniSOM software which should be in "/usr/local/src/msom" and installed.

For "train_msom.py" the relevant parameter to change is:

src.params.filepath = './jan-mar_2019.npy'
This points to the collected data file generated by "collect_data.py". 

The other parameters in "train_msom.py" indicate values for the SOM implementation. These are varied to find an acceptable output and which is quantified by using "run_cramer.py" described below.

Within the WRF defined region, each pixel's daily attribute signal is randomly presented to the SOM clustering algorithm ("train_msom.py") for the specified number of days in "collect_daya.py". Eventually, depending on appropriate parameter values, the clustering will settle to a set of discriminated classes.

Because of the stochastic nature of this process, outputs can vary in class assignations. Similarity measures were implemented to compare numerous runs using the Cramer-V analysis ("cramer.py"). This analysis allows for comparisons between training runs by obtaining not only a similarity measure but also a 1-to-1 mapping of classes for the different runs. The 1-to-1 class mapping allows for the transcription of classes for comparisons. The similarity index given by "cramer.py" is a measure of repeatability between training runs. Here, we adjust the SOM parameters to give a 0.96, or greater, value where possible values are between 0 and 1.

The script "train_som.py" has parameters that have already been tuned for our purposes. The primary variables are the input/output data pointers:

src.params.filepath = 'full2017.npy' # 365 days

and further down, to distinguish training runs:

ms.params.mapfile_prefix = 'full2017_5x5_6_01_3_1'

The output map files contain the clustered classes and is used in "cramer.py" for comparing  training (cluster) runs. These files can also be used by the "apply_class.py" script to show the clustering on the training data and on other WRF data as described below.

For comparisons, we need to change the output variable ms.params.mapfile_prefix value for every run. The convention is to change the numeric value to the grid size, number epochs, learning rate, decay function, and run number. 

NOTE: The above parameters indicate either a 3-month or 1-year input data. For the "eto_weather" paper we used 5 years worth of data which requires at least 256 GB of ram memory.

- Cramer comparisons

\> ./run_cramer.py

The "run_cramer.py" script implements the "cramer.py" script to evaluate a similarity measure value between runs using the same input data. Relevant parameters are:

datafile = 'full2021.npy'
This is the input data for the runs to compare, generated by the "collect_data.py" script.

outfile = 'cramer_2021_5x5_5_00725_3.results'
Where the results can be found.

lutdir = 'LUTs_2021_5x5_5_00725_3/'
The directory where the 1-to-1 class lookup tables are written to.

somset = [ './             LABELS_2021/5x5_5_00725_3/2021_5x5_5_00725_01.labels',
           './LABELS_2021/5x5_5_00725_3/2021_5x5_5_00725_02.labels',
           './LABELS_2021/5x5_5_00725_3/2021_5x5_5_00725_03.labels',
           './LABELS_2021/5x5_5_00725_3/2021_5x5_5_00725_04.labels',
           './LABELS_2021/5x5_5_00725_3/2021_5x5_5_00725_05.labels',
           './LABELS_2021/5x5_5_00725_3/2021_5x5_5_00725_06.labels',
           './LABELS_2021/5x5_5_00725_3/2021_5x5_5_00725_07.labels',
           './LABELS_2021/5x5_5_00725_3/2021_5x5_5_00725_08.labels',
           './LABELS_2021/5x5_5_00725_3/2021_5x5_5_00725_09.labels',
           './LABELS_2021/5x5_5_00725_3/2021_5x5_5_00725_10.labels' ]

These are the specified clustered output class files to compare. The above array will produce 45 comparisons.

- Applying the class file.

./apply_class.py

Use the script "apply_class.py" to render classes on the training data or on later data sets.

Relevant parameters:

fname = '/home/agrineer/eto_weather/dates/full2021.txt'
Filename indicating which files to apply classes to.

outdir = '2021-GA/SOM_5x5_4_00724_3_10/'
Output directory for applied files.
 
output_file = outdir + '2017-2021_labels.npy'    
Applied classes filename.

sclass.params.weightfile = 'LABELS_2017-2021/5x5_4_00724_3/2017-2021_5x5_4_00724_10.labels'
Class (weight) file to use.






